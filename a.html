<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapid Voice Mark Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        pulse: {
                            '0%, 100%': { opacity: 1, transform: 'scale(1)' },
                            '50%': { opacity: .7, transform: 'scale(1.05)' },
                        },
                        "border-flash": {
                            '0%, 100%': { borderColor: 'transparent' },
                            '50%': { borderColor: 'rgb(239 68 68)' },
                        }
                    },
                    animation: {
                        'listen-pulse': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'error-flash': 'border-flash 0.5s ease-in-out 2'
                    }
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        [data-view] { display: none; }
        [data-view].visible { display: block; }
        .q-box {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .q-box.active {
            border: 2px solid #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            transform: scale(1.05);
        }
        .q-box.error-flash {
            animation: error-flash 0.5s ease-in-out 2;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl p-6 md:p-8 transition-all">

        <!-- Upload Screen -->
        <div data-view="upload" class="visible">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">Rapid Voice Mark Sheet</h1>
                <p class="text-gray-600 mt-2">Upload your official PAT Excel file to begin.</p>
            </div>

            <div class="mt-8">
                <label for="file-upload" class="block text-sm font-medium text-gray-700">Excel File (.xlsx)</label>
                <div class="mt-1 flex flex-col sm:flex-row sm:items-center gap-4">
                    <input type="file" id="file-upload" accept=".xlsx" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100
                        cursor-pointer"/>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <strong>Note:</strong> This app is designed for the specific PAT format with "Roll No", "Name of Student's", and question headers on separate rows.
                </p>
            </div>

            <div class="mt-8">
                <button id="process-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-200 disabled:opacity-50" disabled>
                    Process File
                </button>
            </div>
        </div>

        <!-- Data Entry Screen -->
        <div data-view="entry">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                <div>
                    <p id="student-progress" class="text-sm font-medium text-blue-600">Student 1 of 30</p>
                    <h2 class="text-3xl font-bold text-gray-800">
                        <span id="student-roll" class="text-gray-500">1.</span>
                        <span id="student-name">Student Name</span>
                    </h2>
                </div>
                <button id="mic-button" class="flex items-center justify-center gap-3 w-full md:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-200">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93V17.5a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-2.57A6 6 0 014 9V7a.5.5 0 01.5-.5h1A.5.5 0 016 7v2a4 4 0 008 0V7a.5.5 0 01.5-.5h1a.5.5 0 01.5.5v2a6 6 0 01-3 5.43z" clip-rule="evenodd"></path></svg>
                    <span>Start Listening</span>
                </button>
            </div>

            <div class="text-center bg-gray-50 rounded-lg p-4 mb-6 min-h-[80px]">
                <p id="status-text" class="text-lg text-gray-700">Click "Start Listening" to begin data entry.</p>
                <p id="last-heard" class="text-2xl font-bold text-blue-600 mt-1 h-8"></p>
            </div>
            
            <div id="question-grid" class="grid grid-cols-5 md:grid-cols-10 gap-3">
            </div>

            <div class="mt-8 border-t pt-6 flex flex-col md:flex-row gap-4 justify-between">
                <div class="flex gap-4">
                    <button id="prev-student-btn" class="w-full md:w-auto bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all">
                        « Prev Student
                    </button>
                    <button id="next-student-btn" class="w-full md:w-auto bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-900 transition-all">
                        Next Student »
                    </button>
                </div>
                <div class="flex gap-4">
                     <button id="prev-q-btn" class="w-full md:w-auto bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all">
                        ‹ Prev Q
                    </button>
                    <button id="next-q-btn" class="w-full md:w-auto bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all">
                        Next Q ›
                    </button>
                </div>
            </div>

        </div>

        <!-- Completion Screen -->
        <div data-view="complete">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-green-700">Data Entry Complete</h1>
                <p class="text-gray-600 mt-2">All student marks have been recorded.</p>
            </div>

            <div class="mt-8 max-h-[400px] overflow-y-auto rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                            <th id="q-headers"></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button id="download-csv-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-200">
                    Download CSV
                </button>
                <button id="download-excel-button" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-200">
                    Download Excel
                </button>
                <button id="start-over-button" class="w-full bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-700 transition-all duration-200">
                    Start Over
                </button>
            </div>
        </div>

    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold text-red-700">Error</h3>
            <p id="error-message" class="text-gray-600 mt-2">Something went wrong.</p>
            <button id="close-modal-button" class="w-full mt-6 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-all">
                Close
            </button>
        </div>
    </div>

    <script>
        let studentQueue = [];
        let questionHeaders = [];
        let maxMarks = [];
        let questionCols = [];
        let rollNoCol = -1;
        let nameCol = -1;
        
        let currentStudentIndex = 0;
        let currentQuestionIndex = 0;
        
        let speechRecognition;
        let isListening = false;
        let micWasManuallyStopped = false;

        const wordToNumber = {
            'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
            'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
            'to': 2, 'tree': 3, 'for': 4, 'too': 2, 'fore': 4, 'ate': 8,
        };

        const views = document.querySelectorAll('[data-view]');
        const processButton = document.getElementById('process-button');
        const fileInput = document.getElementById('file-upload');
        const micButton = document.getElementById('mic-button');
        const questionGrid = document.getElementById('question-grid');
        
        const studentProgress = document.getElementById('student-progress');
        const studentRoll = document.getElementById('student-roll');
        const studentName = document.getElementById('student-name');
        
        const statusText = document.getElementById('status-text');
        const lastHeard = document.getElementById('last-heard');

        const prevStudentBtn = document.getElementById('prev-student-btn');
        const nextStudentBtn = document.getElementById('next-student-btn');
        const prevQBtn = document.getElementById('prev-q-btn');
        const nextQBtn = document.getElementById('next-q-btn');

        const resultsTableBody = document.getElementById('results-table-body');
        const qHeaders = document.getElementById('q-headers');
        const downloadCsvButton = document.getElementById('download-csv-button');
        const downloadExcelButton = document.getElementById('download-excel-button');
        const startOverButton = document.getElementById('start-over-button');
        
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeModalButton = document.getElementById('close-modal-button');

        function showView(viewName) {
            views.forEach(view => {
                view.classList.toggle('visible', view.dataset.view === viewName);
            });
        }

        function showError(message) {
            console.error(message);
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
        }
        
        function flashErrorOnBox(index) {
            const box = document.getElementById(`q-box-${index}`);
            if (box) {
                box.classList.add('error-flash');
                setTimeout(() => box.classList.remove('error-flash'), 1000);
            }
        }

        function setupSpeechRecognition() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!window.SpeechRecognition) {
                showError("Speech Recognition is not supported in this browser. Please use Google Chrome or Microsoft Edge.");
                micButton.disabled = true;
                micButton.querySelector('span').textContent = "Not Supported";
                return false;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = false;
            speechRecognition.lang = 'en-IN';
            speechRecognition.maxAlternatives = 1;

            speechRecognition.onstart = () => {
                isListening = true;
                micButton.classList.add('bg-red-600', 'hover:bg-red-700', 'animate-listen-pulse');
                micButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                micButton.querySelector('span').textContent = "Stop Listening";
                statusText.textContent = `Listening... Ready for Q${questionHeaders[currentQuestionIndex]}`;
            };

            speechRecognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript.trim().toLowerCase();
                        processTranscript(transcript);
                    }
                }
            };
            
            speechRecognition.onend = () => {
                isListening = false;
                
                if (micWasManuallyStopped) {
                    micButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'animate-listen-pulse');
                    micButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    micButton.querySelector('span').textContent = "Start Listening";
                    statusText.textContent = "Mic is off. Click 'Start Listening' to resume.";
                    lastHeard.textContent = "";
                } else {
                    statusText.textContent = "Mic disconnected. Trying to reconnect...";
                    setTimeout(() => {
                        if (!isListening && !micWasManuallyStopped) {
                            try {
                                speechRecognition.start();
                            } catch (e) {
                                console.error("Mic restart error:", e);
                                statusText.textContent = "Mic restart failed. Please click 'Start'.";
                                micButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'animate-listen-pulse');
                                micButton.classList.add('bg-green-600', 'hover:bg-green-700');
                                micButton.querySelector('span').textContent = "Start Listening";
                                lastHeard.textContent = "";
                            }
                        }
                    }, 1000);
                }
            };

            speechRecognition.onerror = (event) => {
                if (event.error === 'not-allowed') {
                    showError("Microphone access was denied. Please allow microphone access in your browser settings and refresh the page.");
                } else if (event.error !== 'no-speech' && event.error !== 'audio-capture') {
                    console.error('Speech Error:', event.error);
                } else if (event.error === 'audio-capture') {
                    if (isListening) {
                        micWasManuallyStopped = true;
                        speechRecognition.stop();
                    }
                    showError("Microphone audio capture failed. Please check your microphone and refresh.");
                }
            };
            return true;
        }

        function toggleListening() {
            if (isListening) {
                micWasManuallyStopped = true;
                speechRecognition.stop();
            } else {
                try {
                    micWasManuallyStopped = false;
                    speechRecognition.start();
                } catch(e) {
                    showError("Could not start microphone. Please ensure permissions are granted.");
                    console.error("Mic start error:", e);
                }
            }
        }
        
        function handleProcessFile() {
            const file = fileInput.files[0];
            if (!file) return;

            processButton.textContent = "Processing...";
            processButton.disabled = true;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (json.length < 9) {
                        throw new Error("File format is incorrect. Expected at least 9 rows for headers.");
                    }
                    
                    const headerRow = json[4]; 
                    const questionRow = json[6]; 
                    const maxMarksRow = json[7];
                    
                    questionHeaders = [];
                    maxMarks = [];
                    questionCols = [];
                    rollNoCol = -1;
                    nameCol = -1;

                    for (let i = 0; i < headerRow.length; i++) {
                        const cell = String(headerRow[i] || '').trim();
                        if (cell === "Roll No") rollNoCol = i;
                        if (cell === "Name of Student's") nameCol = i;
                    }

                    if (rollNoCol === -1 || nameCol === -1) {
                        throw new Error("Could not find 'Roll No' and 'Name of Student's' headers in row 5.");
                    }
                    
                    let queNoColIndex = -1;
                    for (let i = 0; i < questionRow.length; i++) {
                        if (String(questionRow[i] || '').trim() === "QUE.NO") {
                            queNoColIndex = i;
                            break;
                        }
                    }

                    if (queNoColIndex === -1) {
                        throw new Error("Could not find 'QUE.NO' header in row 7.");
                    }

                    let foundQuestions = false;
                    for (let i = queNoColIndex + 1; i < questionRow.length; i++) {
                        const qNum = String(questionRow[i] || '').trim();
                        const qMark = parseInt(String(maxMarksRow[i] || '').trim());
                        
                        if (qNum.match(/^\d{1,2}$/) && !isNaN(qMark)) {
                            foundQuestions = true;
                            questionHeaders.push(qNum);
                            maxMarks.push(qMark);
                            questionCols.push(i);
                        } else if (foundQuestions) {
                            break; 
                        }
                    }

                    if (questionHeaders.length === 0) {
                        throw new Error("Could not find any Question (Q.No) headers in row 7.");
                    }

                    studentQueue = [];
                    const dataRows = json.slice(8);
                    
                    dataRows.forEach(row => {
                        const rollNo = row[rollNoCol];
                        const studentName = row[nameCol];

                        if (studentName && String(studentName).trim()) {
                            studentQueue.push({
                                rollNo: rollNo || '',
                                studentName: String(studentName).trim(),
                                marks: Array(questionHeaders.length).fill('')
                            });
                        }
                    });

                    if (studentQueue.length === 0) {
                        throw new Error("No students found in the file.");
                    }
                    
                    setupQuestionGrid();
                    displayCurrentStudent();
                    showView('entry');

                } catch (err) {
                    showError(`File Processing Error: ${err.message}`);
                } finally {
                    processButton.textContent = "Process File";
                    processButton.disabled = false;
                    fileInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function setupQuestionGrid() {
            questionGrid.innerHTML = '';
            questionHeaders.forEach((qNum, index) => {
                const box = document.createElement('div');
                box.id = `q-box-${index}`;
                box.className = "q-box bg-gray-100 rounded-lg p-3 text-center cursor-pointer";
                box.innerHTML = `
                    <div class="text-xs font-bold text-gray-500">Q${qNum} (Max: ${maxMarks[index]})</div>
                    <div class="text-2xl font-bold text-gray-900 h-8"></div>
                `;
                box.addEventListener('click', () => highlightQuestion(index));
                questionGrid.appendChild(box);
            });
        }
        
        function displayCurrentStudent() {
            if (currentStudentIndex >= studentQueue.length) {
                showCompletionScreen();
                return;
            }
            
            const student = studentQueue[currentStudentIndex];
            studentProgress.textContent = `Student ${currentStudentIndex + 1} of ${studentQueue.length}`;
            studentRoll.textContent = `${student.rollNo}.`;
            studentName.textContent = student.studentName;
            
            updateQuestionGrid();
            highlightQuestion(0);
        }
        
        function updateQuestionGrid() {
            const student = studentQueue[currentStudentIndex];
            student.marks.forEach((mark, index) => {
                const box = document.getElementById(`q-box-${index}`);
                if (box) {
                    box.querySelector('.text-2xl').textContent = mark;
                }
            });
        }
        
        function highlightQuestion(index) {
            currentQuestionIndex = index;
            document.querySelectorAll('.q-box').forEach(box => {
                box.classList.remove('active');
            });
            const activeBox = document.getElementById(`q-box-${index}`);
            if (activeBox) {
                activeBox.classList.add('active');
                activeBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            if (isListening) {
                statusText.textContent = `Listening... Ready for Q${questionHeaders[currentQuestionIndex]}`;
            }
        }
        
        function processTranscript(transcript) {
            lastHeard.textContent = `"${transcript}"`;
            
            let commandProcessed = false;
            
            // Check for "yes" or "next" to confirm moving to next student
            if (transcript === 'yes' || transcript === 'yeah' || transcript === 'yep' || transcript === 'next') {
                if (currentQuestionIndex >= questionHeaders.length) {
                    goToNextStudent();
                    commandProcessed = true;
                } else if (transcript === 'next') {
                    // Allow "next" to move to next student even if not all questions filled
                    goToNextStudent();
                    commandProcessed = true;
                }
            } else if (transcript === 'no' || transcript === 'nope') {
                if (currentQuestionIndex >= questionHeaders.length) {
                    // Go back to first question of current student
                    highlightQuestion(0);
                    statusText.textContent = `Back to Q1. Ready for marks.`;
                    commandProcessed = true;
                }
            } else if (transcript.includes('next student')) {
                goToNextStudent();
                commandProcessed = true;
            } else if (transcript.includes('previous student') || transcript.includes('back student')) {
                goToPrevStudent();
                commandProcessed = true;
            } else if (transcript === 'clear' || transcript === 'remove' || transcript === 'reset') {
                // Clear all marks for current student
                studentQueue[currentStudentIndex].marks = Array(questionHeaders.length).fill('');
                updateQuestionGrid();
                highlightQuestion(0);
                statusText.textContent = `All marks cleared. Ready for Q1.`;
                commandProcessed = true;
            }
            
            if (commandProcessed) {
                return;
            }

            // Extract all digits from the transcript
            const allDigits = [];
            const words = transcript.split(/\s+/); // Split by spaces
            
            words.forEach(word => {
                // Try word-to-number conversion first
                let num = wordToNumber[word];
                if (num !== undefined) {
                    allDigits.push(num);
                } else {
                    // Extract digits from the word
                    const digits = word.match(/\d/g);
                    if (digits) {
                        digits.forEach(d => allDigits.push(parseInt(d)));
                    }
                }
            });

            if (allDigits.length === 0) {
                statusText.textContent = `Didn't catch any numbers. Say all ${questionHeaders.length} marks.`;
                return;
            }

            // Process all digits and fill questions
            let questionIdx = currentQuestionIndex;
            let invalidFound = false;
            let digitsProcessed = 0;
            
            for (let i = 0; i < allDigits.length && questionIdx < questionHeaders.length; i++) {
                const digit = allDigits[i];
                const max = maxMarks[questionIdx];
                
                if (digit < 0 || digit > max) {
                    flashErrorOnBox(questionIdx);
                    statusText.textContent = `Invalid mark ${digit} for Q${questionHeaders[questionIdx]}! Max is ${max}. Say marks again from Q${questionHeaders[currentQuestionIndex]}.`;
                    invalidFound = true;
                    break;
                }
                
                studentQueue[currentStudentIndex].marks[questionIdx] = digit;
                digitsProcessed++;
                questionIdx++;
            }
            
            if (invalidFound) {
                return;
            }
            
            // Update the grid and current position
            updateQuestionGrid();
            
            if (questionIdx >= questionHeaders.length) {
                // All questions filled
                currentQuestionIndex = questionHeaders.length;
                highlightQuestion(questionHeaders.length - 1); // Highlight last question
                statusText.textContent = `All ${questionHeaders.length} marks entered! Say "yes" for next student or "no" to review.`;
            } else {
                // Partially filled, update position
                currentQuestionIndex = questionIdx;
                highlightQuestion(currentQuestionIndex);
                const remaining = questionHeaders.length - questionIdx;
                statusText.textContent = `Got ${digitsProcessed} marks. ${remaining} more needed. Ready for Q${questionHeaders[currentQuestionIndex]}.`;
            }
        }

        function setMarkForCurrentQuestion(mark) {
            studentQueue[currentStudentIndex].marks[currentQuestionIndex] = mark;
            updateQuestionGrid();
        }

        function goToNextQuestion() {
            if (currentQuestionIndex < questionHeaders.length - 1) {
                highlightQuestion(currentQuestionIndex + 1);
            }
        }
        function goToPrevQuestion() {
            if (currentQuestionIndex > 0) {
                highlightQuestion(currentQuestionIndex - 1);
            }
        }
        function goToNextStudent() {
            if (currentStudentIndex < studentQueue.length - 1) {
                currentStudentIndex++;
                displayCurrentStudent();
            } else {
                showCompletionScreen();
            }
        }
        function goToPrevStudent() {
            if (currentStudentIndex > 0) {
                currentStudentIndex--;
                displayCurrentStudent();
            }
        }
        
        function showCompletionScreen() {
            if(isListening) {
                micWasManuallyStopped = true;
                speechRecognition.stop();
            }
            showView('complete');
            
            qHeaders.innerHTML = questionHeaders.map(q => 
                `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Q${q}</th>`
            ).join('');
            
            resultsTableBody.innerHTML = "";
            studentQueue.forEach(student => {
                const row = document.createElement('tr');
                let total = 0;
                let marksHtml = student.marks.map(mark => {
                    const val = Number(mark);
                    if (!isNaN(val)) total += val;
                    return `<td class="px-4 py-2 whitespace-nowrap font-medium">${mark}</td>`;
                }).join('');
                
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap">${student.rollNo}</td>
                    <td class="px-4 py-2 whitespace-nowrap font-medium text-gray-900">${student.studentName}</td>
                    ${marksHtml}
                    <td class="px-4 py-2 whitespace-nowrap font-bold text-gray-900">${total}</td>
                `;
                resultsTableBody.appendChild(row);
            });
        }
        
        function downloadCSV() {
            const headers = ["RollNo", "StudentName", ...questionHeaders.map(q => `Q${q}`), "Total"].join(',');
            
            const csvRows = studentQueue.map(student => {
                let total = 0;
                const marks = student.marks.map(mark => {
                    total += Number(mark) || 0;
                    return `"${mark}"`;
                }).join(',');
                
                return [`"${student.rollNo}"`, `"${student.studentName}"`, marks, total].join(',');
            });
            
            let csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + csvRows.join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student_marks_entry.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function downloadExcel() {
            try {
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                
                // Prepare data for Excel
                const excelData = [];
                
                // Add headers
                const headers = ["Roll No", "Student Name", ...questionHeaders.map(q => `Q${q}`), "Total"];
                excelData.push(headers);
                
                // Add student data
                studentQueue.forEach(student => {
                    let total = 0;
                    const marks = student.marks.map(mark => {
                        const val = Number(mark) || 0;
                        total += val;
                        return mark === '' ? '' : mark;
                    });
                    
                    excelData.push([student.rollNo, student.studentName, ...marks, total]);
                });
                
                // Create worksheet from data
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Set column widths
                const colWidths = [
                    { wch: 10 },  // Roll No
                    { wch: 25 },  // Student Name
                    ...questionHeaders.map(() => ({ wch: 8 })), // Questions
                    { wch: 10 }   // Total
                ];
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, "Marks");
                
                // Generate Excel file and trigger download
                XLSX.writeFile(wb, "student_marks_entry.xlsx");
                
                console.log("Excel file generated successfully");
            } catch (error) {
                console.error("Excel download error:", error);
                showError("Failed to generate Excel file: " + error.message);
            }
        }
        
        function startOver() {
            studentQueue = [];
            currentStudentIndex = 0;
            currentQuestionIndex = 0;
            fileInput.value = "";
            processButton.disabled = true;
            micWasManuallyStopped = false;
            showView('upload');
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!setupSpeechRecognition()) {
                return;
            }

            fileInput.addEventListener('change', () => {
                processButton.disabled = !fileInput.files[0];
            });
            
            processButton.addEventListener('click', handleProcessFile);
            micButton.addEventListener('click', toggleListening);
            
            prevStudentBtn.addEventListener('click', goToPrevStudent);
            nextStudentBtn.addEventListener('click', goToNextStudent);
            prevQBtn.addEventListener('click', goToPrevQuestion);
            nextQBtn.addEventListener('click', goToNextQuestion);
            
            downloadCsvButton.addEventListener('click', downloadCSV);
            downloadExcelButton.addEventListener('click', downloadExcel);
            startOverButton.addEventListener('click', startOver);
            closeModalButton.addEventListener('click', () => {
                errorModal.style.display = 'none';
            });
        });

    </script>
</body>
</html>
